<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bakery Admin Dashboard</title>
    <link rel="stylesheet" href="/css/admin.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/inventory.js" defer></script>
    <script src="/js/feedback.js"></script>
    <script src="/js/customOrders.js" defer></script>
  </head>
  <body>
    <script>const currentUserId = "<%= user ? user._id : '' %>";</script>
    <div class="sidebar">
      <h2>Bakery Admin</h2>
      <a onclick="showSection('modern-dashboard')">Dashboard Overview</a>
      <a onclick="showSection('account')"> Account Management</a>
      <a onclick="showSection('inventory')">Inventory</a>
      <a onclick="showSection('orders')" > Order Management</a>
      <a onclick="showSection('requests')" >Special Requests</a>
      <a onclick="showSection('users')"> User Management</a >
      <a onclick="showSection('sales')" > Sales Analysis</a >
      <a onclick="showSection('feedback')"> Feedback & Reviews</a >
    </div>

    <div class="main">
      <div class="navbar">
        <h1>Dashboard Overview</h1>
        <span>Welcome, Admin!</span>
        <button onclick="window.location.href='/api/v1/users/logout'" class="btn btn-link p-0" style="text-decoration: none; color: #000; border: 1px solid #000; border-radius: 20px; padding: 5px 15px !important; transition: all 0.3s ease;">Logout</button>
      </div>

      <div id="modern-dashboard" class="section active-section">
        <div class="card-container">
          <div class="card highlight-card">
            <h3>ðŸŽ‰ Best seller of the month</h3>
            <p id="bestSellerName">Loading...</p>
            <h2 style="color: #4e73df" id="bestSellerRevenue">$0</h2>
            <p id="bestSellerTarget">0% of target ðŸš€</p>
          </div>

          <div class="card highlight-card">
            <h3>Sales</h3>
            <p>Total Sales</p>
            <h2 style="color: #4e73df" id="totalSales">$0</h2>
            <p style="color: #28a745" id="salesGrowth">+0%</p>
          </div>

          <div class="card highlight-card">
            <h3>Orders</h3>
            <p>Total Orders</p>
            <h2 style="color: #4e73df" id="dashboardOrdersTotal">0</h2>
            <p style="color: #28a745" id="ordersGrowth"></p>
          </div>

          <div class="card highlight-card">
            <h3>Customer Orders</h3>
            <p>Order Value</p>
            <h2 style="color: #4e73df" id="customerOrdersValue">$0</h2>
            <p style="color: #28a745" id="customerOrdersGrowth">+0%</p>
          </div>

          <div class="card highlight-card">
            <h3>Profit</h3>
            <p>Net Profit</p>
            <h2 style="color: #4e73df" id="totalProfit">$0</h2>
            <!-- Mini bar chart for profit -->
            <div id="profitChart" class="chart" style="margin-top:10px"></div>
            <div id="profitLabels" class="labels"></div>
          </div>
        </div>

        <div class="chart-container">
          <h3>Total Income (Yearly)</h3>
          <canvas id="incomeChart"></canvas>
        </div>
      </div>

      


      <div id="inventory" class="section">
        <div class="card-container">
          <div class="card highlight-card">
            <h3>Inventory Items</h3>
            <p id="totalItems">0</p>
          </div>
          <div class="card highlight-card">
            <button class="btn btn-primary" onclick="showAddProductForm()">
              <i class="bi bi-plus-circle"></i> Add New Product
            </button>
          </div>
        </div>

        <!-- Add/Edit Product Form -->
        <div id="productForm" class="chart-container" style="display: none;">
          <h3 id="formTitle">Add New Product</h3>
          <form id="inventoryForm" class="user-form">
            <input type="hidden" id="productId">
            <div class="row">
              <div class="col-md-6">
                <label for="name">Product Name:</label>
                <input type="text" id="name" name="name" required>

                <label for="category">Category:</label>
                <select id="category" name="category" required>
                  <option value="Cake">Cake</option>
                  <option value="Cookie">Cookie</option>
                  <option value="Croissant">Croissant</option>
                </select>

                <label for="imageUrl">Image URL:</label>
                <input type="text" id="imageUrl" name="imageUrl">

                <label for="pricePackWhole">Pack Price ($):</label>
                <input type="number" id="pricePackWhole" name="pricePackWhole" min="0" step="0.01" required>

                <label for="pricePiece">Piece Price ($):</label>
                <input type="number" id="pricePiece" name="pricePiece" min="0" step="0.01">
              </div>
              <div class="col-md-6">
                <label for="description">Description:</label>
                <textarea id="description" name="description"></textarea>

                <label for="ingredients">Ingredients (comma-separated):</label>
                <input type="text" id="ingredients" name="ingredients">

                <label for="inStock">In Stock:</label>
                <select id="inStock" name="inStock">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>

                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" min="0" required>

                <label for="tags">Tags (comma-separated):</label>
                <input type="text" id="tags" name="tags">
              </div>
            </div>
            <div class="form-buttons">
              <button type="submit" class="btn btn-primary">Save</button>
              <button type="button" class="btn btn-secondary" onclick="hideProductForm()">Cancel</button>
            </div>
          </form>
        </div>

        <div class="chart-container">
          <h3>Inventory Status</h3>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Product Name</th>
                  <th>Category</th>
                  <th>Photo</th>
                  <th>Pack Price ($)</th>
                  <th>Piece Price ($)</th>
                  <th>Description</th>
                  <th>Ingredients</th>
                  <th>In Stock</th>
                  <th>Quantity</th>
                  <th>Tags</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventory-tbody">
                <!-- Products will be loaded here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div id="orders" class="section">
        <div class="card-container">
          <div class="card highlight-card">
            <h3>Order Management</h3>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p>Total Orders: <span id="ordersTotal">0</span></p>
                <p>Pending Orders: <span id="pendingOrders">0</span></p>
              </div>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <h3>Order Management Status</h3>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Order Number</th>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Address</th>
                  <th>Items</th>
                  <th>Total Price</th>
                  <th>Status</th>
                  <th>Payment</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="orders-tbody">
                <!-- Orders will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="requests" class="section">
        <div class="card-container">
          <div class="card highlight-card">
            <h3>Special Requests</h3>
            <p id="totalRequests">0</p>
            <button class="btn btn-primary" onclick="showAddRequestForm()">
              <i class="bi bi-plus-circle"></i> Add New Request
            </button>
          </div>
        </div>

        <!-- Add/Edit Request Form -->
        <div id="requestForm" class="chart-container" style="display: none;">
          <h3 id="formTitle">Add New Request</h3>
          <form id="customOrderForm" class="user-form">
            <input type="hidden" id="requestId">
            <div class="row">
              <div class="col-md-6">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName" name="firstName" required>

                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName" name="lastName" required>

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>

                <label for="phone">Phone:</label>
                <input type="text" id="phone" name="phone" required>

                <label for="address">Address:</label>
                <input type="text" id="address" name="address" required>
              </div>
              <div class="col-md-6">
                <label for="description">Description:</label>
                <textarea id="description" name="description" required></textarea>

                <label for="imageUrl">Image URL:</label>
                <input type="text" id="imageUrl" name="imageUrl">

                <label for="preferredDate">Preferred Date:</label>
                <input type="date" id="preferredDate" name="preferredDate">

                <label for="notes">Notes:</label>
                <textarea id="notes" name="notes"></textarea>

                <label for="status">Status:</label>
                <select id="status" name="status">
                  <option value="pending">Pending</option>
                  <option value="processing">Processing</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>
            <div class="form-buttons">
              <button type="submit" class="btn btn-primary">Save</button>
              <button type="button" class="btn btn-secondary" onclick="hideRequestForm()">Cancel</button>
            </div>
          </form>
        </div>

        <div class="chart-container">
          <h3>Special Requests Status</h3>
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Customer Name</th>
                  <th>Contact Info</th>
                  <th>Order Details</th>
                  <th>Status</th>
                  <th>Created At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requests-tbody">
                <!-- Requests will be loaded here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="users" class="section">
        <div
          class="users-flex-container"
          style="display: flex; gap: 2rem; align-items: flex-start"
        >
          <div style="flex: 1; max-width: 700px;">
            <h3 style="text-align:center; margin-bottom:1rem;">Edit Users</h3>
            <input type="text" id="search" placeholder="Search users..." />
            <table class="user-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="users-tbody">
                <% users.forEach(user => { %>
                <tr>
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td><%= user.phone || 'N/A' %></td>
                  <td>
                    <select class="form-select form-select-sm user-role-select" data-id="<%= user._id %>">
                      <option value="" disabled selected><%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %></option>
                      <option value="customer">Customer</option>
                      <option value="admin">Admin</option>
                    </select>
                  </td>
                  <td>
                    <span
                      class="status <%= user.isActive ? 'active' : 'inactive' %>"
                    >
                      <%= user.isActive ? 'Active' : 'Inactive' %>
                    </span>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button
                        class="btn btn-secondary dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                      >
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <button
                            class="dropdown-item toggle-status"
                            data-id="<%= user._id %>"
                          >
                            <i class="bi bi-toggle-on"></i> <%= user.isActive ?
                            'Deactivate' : 'Activate' %>
                          </button>
                        </li>
                        <li>
                          <button
                            class="dropdown-item delete text-danger delete-btn"
                            data-id="<%= user._id %>"
                          >
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="sales" class="section">
        <div class="card-container" style="display: flex; gap: 2rem">
          <div class="card highlight-card" style="flex: 1">
            <h3>Best Seller Product</h3>
            <p id="salesBestSellerName" class="mb-2">Loading...</p>
            <h2 style="color: #4e73df" id="salesBestSellerRevenue">$0</h2>
            <p id="salesBestSellerCount" class="text-muted">0 sold this month</p>
          </div>
          <div class="card highlight-card" style="flex: 1">
            <h3>Top Customer</h3>
            <p id="salesTopCustomerName" class="mb-2">Loading...</p>
            <h2 style="color: #4e73df" id="salesTopCustomerSpend">$0</h2>
            <p id="salesTopCustomerOrders" class="text-muted">0 orders this month</p>
          </div>
          <div class="card highlight-card" style="flex: 1">
            <h3>Highest Growth Category</h3>
            <p id="salesTopCategoryName" class="mb-2">Loading...</p>
            <h2 style="color: #4e73df" id="salesTopCategorySales">$0</h2>
            <p id="salesTopCategoryCount" class="text-muted">0 sales this month</p>
          </div>
        </div>
        <div class="chart-container">
          <h3>Monthly Sales (EGP)</h3>
          <canvas id="monthlySalesChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Orders by Status</h3>
          <canvas id="ordersStatusChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Sales by Category (EGP)</h3>
          <canvas id="categorySalesChart"></canvas>
        </div>
      </div>

      <div id="feedback" class="section">
       
        <div class="chart-container">
          <h3>Customer Feedback List</h3>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Feedback</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="feedback-tbody">
                <!-- Feedback rows will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div id="account" class="section">
        <div class="profile-container" style="display: flex; gap: 2rem">
          <div class="chart-container" style="flex: 1">
            <h3>Profile Information</h3>
            <form class="user-form" id="accountForm">
              <label for="adminName">Full Name:</label>
              <input type="text" id="adminName" value="<%= user ? user.name : '' %>" required />

              <label for="adminEmail">Email:</label>
              <input
                type="email"
                id="adminEmail"
                value="<%= user ? user.email : '' %>"
                required
              />

              <label for="adminPhone">Phone:</label>
              <input type="tel" id="adminPhone" value="<%= user && user.phone ? user.phone : '' %>" />

              <button type="submit">Save Changes</button>
            </form>
          </div>
          <div class="chart-container" style="flex: 1">
            <h3>Change Password</h3>
            <form class="user-form" id="passwordForm">
              <label for="currentPass">Current Password:</label>
              <input type="password" id="currentPass" required />

              <label for="newPass">New Password:</label>
              <input type="password" id="newPass" minlength="6" />

              <label for="confirmPass">Confirm Password:</label>
              <input type="password" id="confirmPass" minlength="6" />

              <button type="button" id="updatePassBtn" class="save-btn">Update Password</button>
            </form>
          </div>
        </div>
      </div>

      <div id="products" class="section">
        <div class="card-container">
          <div class="card highlight-card"><h3>Product Management</h3></div>
        </div>
        <div class="chart-container">
          <h3>All Products</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price (Whole)</th>
                  <th>Price (Piece)</th>
                  <th>Stock</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="products-tbody">
                <!-- Product rows will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const userId = btn.getAttribute("data-id");

            console.log(userId);

            if (confirm("Are you sure you want to delete this user?")) {
              try {
                const response = await fetch(`/api/v1/users/${userId}`, {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json",
                  },
                });

                if (response.ok) {
                  btn.closest("tr").remove();
                  alert("User deleted successfully");
                } else {
                  alert("Failed to delete user");
                }
              } catch (error) {
                console.error("Error deleting user:", error);
                alert("Error deleting user");
              }
            }
          });
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Fetch dashboard overview data
        const fetchDashboardData = async () => {
          try {
            console.log('Fetching dashboard data...');
            const response = await fetch('/api/v1/admin/dashboard-overview');
            console.log('Response status:', response.status);
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Dashboard data:', data);
            return data;
          } catch (error) {
            console.error('Error fetching dashboard data:', error);
            return null;
          }
        };

        // Update dashboard overview
        const updateDashboardOverview = (data) => {
          if (!data) {
            console.log('No data received');
            return;
          }

          console.log('Updating dashboard with data:', data);

          // Update Best Seller
          document.getElementById('bestSellerName').textContent = data.bestSeller.name;
          document.getElementById('bestSellerRevenue').textContent = `$${data.bestSeller.revenue.toFixed(2)}`;
          document.getElementById('bestSellerTarget').textContent = `${data.bestSeller.targetPercentage}% of target ðŸš€`;

          // Update Sales
          document.getElementById('totalSales').textContent = `$${data.sales.total.toFixed(2)}`;
          document.getElementById('salesGrowth').textContent = `+${data.sales.growth}%`;

          // Update Orders
          document.getElementById('dashboardOrdersTotal').textContent = data.orders.total;
          document.getElementById('ordersGrowth').textContent = `+${data.orders.growth}%`;

          // Update Customer Orders
          document.getElementById('customerOrdersValue').textContent = `$${data.customerOrders.value.toFixed(2)}`;
          document.getElementById('customerOrdersGrowth').textContent = `+${data.customerOrders.growth}%`;

          // Update Profit
          document.getElementById('totalProfit').textContent = `$${data.profit.total.toFixed(2)}`;

          // Update Profit Chart
          const profitChart = document.getElementById('profitChart');
          profitChart.innerHTML = data.profit.chart.data.map(height => 
            `<div class="bar" style="height: ${height}%"></div>`
          ).join('');

          const profitLabels = document.getElementById('profitLabels');
          profitLabels.innerHTML = data.profit.chart.labels.map(label => 
            `<span>${label}</span>`
          ).join('');

          // Update Yearly Income Chart
          const ctx = document.getElementById('incomeChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.yearlyIncome.labels,
              datasets: [{
                label: 'Total Income',
                data: data.yearlyIncome.data,
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                borderColor: '#4e73df',
                borderWidth: 2,
                fill: true
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        };

        // Initialize dashboard
        console.log('Initializing dashboard...');
        const dashboardData = await fetchDashboardData();
        updateDashboardOverview(dashboardData);

        // Refresh dashboard data every 5 minutes
        setInterval(async () => {
          console.log('Refreshing dashboard data...');
          const newData = await fetchDashboardData();
          updateDashboardOverview(newData);
        }, 300000);
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Search functionality
        const searchInput = document.getElementById("search");
        const userTable = document.getElementById("users-tbody");
        
        searchInput.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const rows = userTable.getElementsByTagName("tr");
          
          Array.from(rows).forEach(row => {
            const name = row.cells[0].textContent.toLowerCase();
            const email = row.cells[1].textContent.toLowerCase();
            const phone = row.cells[2].textContent.toLowerCase();
            
            if (name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

        // Edit functionality
        document.querySelectorAll(".edit").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const userId = btn.getAttribute("data-id");
            const row = btn.closest("tr");
            
            try {
              // Fetch user data from the server
              const response = await fetch(`/api/v1/users/${userId}`);
              if (!response.ok) {
                throw new Error('Failed to fetch user data');
              }
              const userData = await response.json();
              
              // Populate form with user data
              const form = document.querySelector(".user-form");
              form.setAttribute("data-user-id", userId);
              
              // Set form values
              document.getElementById("name").value = userData.name || '';
              document.getElementById("email").value = userData.email || '';
              document.getElementById("phone").value = userData.phone || '';
              
              // Set role value
              const roleSelect = document.getElementById("role");
              roleSelect.value = userData.role || 'customer';
              
              // Set isActive value
              const isActiveSelect = document.getElementById("isActive");
              isActiveSelect.value = userData.isActive ? "true" : "false";
              
              // Scroll to form
              form.scrollIntoView({ behavior: 'smooth' });
              
              // Add visual feedback
              form.classList.add('editing');
              
              // Change submit button text
              const submitBtn = form.querySelector('button[type="submit"]');
              if (submitBtn) {
                submitBtn.textContent = 'Update User';
              }
            } catch (error) {
              console.error('Error fetching user data:', error);
              alert('Failed to load user data. Please try again.');
            }
          });
        });

        // Toggle status functionality
        document.querySelectorAll(".toggle-status").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const userId = btn.getAttribute("data-id");
            const row = btn.closest("tr");
            const statusCell = row.cells[4].querySelector(".status");
            const currentStatus = statusCell.textContent.trim();
            const newStatus = currentStatus === "Active" ? "Inactive" : "Active";
            
            try {
              const response = await fetch(`/api/v1/users/${userId}/toggle-status`, {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ isActive: newStatus === "Active" }),
              });

              if (response.ok) {
                statusCell.textContent = newStatus;
                statusCell.className = `status ${newStatus.toLowerCase()}`;
                btn.innerHTML = `<i class="bi bi-toggle-on"></i> ${newStatus === "Active" ? "Deactivate" : "Activate"}`;
              } else {
                alert("Failed to update user status");
              }
            } catch (error) {
              console.error("Error updating user status:", error);
              alert("Error updating user status");
            }
          });
        });

        // Form submission for add/edit user
        const userForm = document.querySelector(".user-form");
        userForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const userId = userForm.getAttribute("data-user-id");
          
          // Get form values
          const name = document.getElementById("name").value;
          const email = document.getElementById("email").value;
          const phone = document.getElementById("phone").value;
          const role = document.getElementById("role").value;
          const isActive = document.getElementById("isActive").value === "true";

          const formData = {
            name,
            email,
            phone,
            role,
            isActive
          };

          console.log('Submitting form with data:', formData);
          console.log('User ID:', userId);

          try {
            const url = userId ? `/api/v1/users/${userId}` : "/api/v1/users";
            const method = userId ? "PUT" : "POST";
            
            console.log('Making request to:', url);
            console.log('Using method:', method);

            const response = await fetch(url, {
              method: method,
              headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify(formData)
            });

            console.log('Response status:', response.status);
            
            const responseData = await response.json();
            console.log('Response data:', responseData);

            if (!response.ok) {
              throw new Error(responseData.error || 'Failed to save user');
            }

            alert(userId ? "User updated successfully" : "User added successfully");
            
            // Reset form
            userForm.reset();
            userForm.removeAttribute("data-user-id");
            userForm.classList.remove("editing");
            const submitBtn = userForm.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.textContent = 'Save';
            }
            
            // Refresh the page to show updated data
            location.reload();
          } catch (error) {
            console.error("Error saving user:", error);
            alert(`Error saving user: ${error.message}`);
          }
        });

        // Add form validation
        userForm.addEventListener('input', (e) => {
          const nameInput = document.getElementById("name");
          const emailInput = document.getElementById("email");
          const phoneInput = document.getElementById("phone");
          
          // Basic validation
          nameInput.setCustomValidity(nameInput.value.trim() === '' ? 'Name is required' : '');
          emailInput.setCustomValidity(emailInput.value.trim() === '' ? 'Email is required' : '');
          
          // Phone validation (optional)
          if (phoneInput.value.trim() !== '') {
            const phoneRegex = /^01[0125][0-9]{8}$/;
            phoneInput.setCustomValidity(phoneRegex.test(phoneInput.value) ? '' : 'Invalid phone number format');
          } else {
            phoneInput.setCustomValidity('');
          }
        });

        // Prevent form submission if validation fails
        userForm.addEventListener('submit', (e) => {
          if (!userForm.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
            alert('Please fill in all required fields correctly');
          }
        });

        // Add loading state to form submission
        userForm.addEventListener('submit', async (e) => {
          const submitBtn = userForm.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
          }
        });
      });
    </script>
  
    <script>
      // Load orders when the orders section is shown
      document.addEventListener('DOMContentLoaded', () => {
        const ordersTab = document.querySelector('[onclick="showSection(\'orders\')"]');
        if (ordersTab) {
          ordersTab.addEventListener('click', loadOrders);
        }
      });

      // Fetch orders from backend and display in the table
      async function loadOrders() {
        try {
          const response = await fetch('/api/v1/orders', { credentials: 'include' });
          if (!response.ok) {
            throw new Error('Failed to fetch orders');
          }
          const orders = await response.json();
          const tbody = document.getElementById('orders-tbody');
          tbody.innerHTML = '';

          // Update order counts
          document.getElementById('ordersTotal').textContent = orders.length;
          document.getElementById('pendingOrders').textContent = 
            orders.filter(order => order.status === 'Pending').length;

          orders.forEach(order => {
            const shipping = order.shippingInfo || {};
            const address = shipping.address
              ? `${shipping.address.street}, ${shipping.address.city}, ${shipping.address.governorate}`
              : '-';
            const items = order.items && order.items.length
              ? order.items.map(item => `${item.name} (x${item.quantity})`).join('<br>')
              : '-';

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${order.orderNumber}</td>
              <td>${shipping.firstName || ''} ${shipping.lastName || ''}</td>
              <td>${shipping.email || '-'}</td>
              <td>${shipping.phone || '-'}</td>
              <td>${address}</td>
              <td>${items}</td>
              <td>${order.totalPrice} ${order.currency || 'EGP'}</td>
              <td>
                <select class="form-select form-select-sm" onchange="updateOrderStatus('${order._id}', this.value)">
                  <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                  <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                  <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                  <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
              </td>
              <td>${order.paymentMethod} (${order.paymentStatus})</td>
              <td>${new Date(order.createdAt).toLocaleString()}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order._id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error('Error loading orders:', error);
          alert('Failed to load orders. Please try again.');
        }
      }

      // Update order status
      async function updateOrderStatus(orderId, newStatus) {
        try {
          const response = await fetch(`/api/v1/orders/status/${orderId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ status: newStatus })
          });

          if (!response.ok) {
            throw new Error('Failed to update order status');
          }

          await loadOrders(); // Refresh the orders list
          alert('Order status updated successfully');
        } catch (error) {
          console.error('Error updating order status:', error);
          alert('Failed to update order status');
        }
      }

      // Delete order
      async function deleteOrder(orderId) {
        if (!confirm('Are you sure you want to delete this order?')) {
          return;
        }

        try {
          const response = await fetch(`/api/v1/orders/${orderId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to delete order');
          }

          await loadOrders(); // Refresh the orders list
          alert('Order deleted successfully');
        } catch (error) {
          console.error('Error deleting order:', error);
          alert('Failed to delete order');
        }
      }
    </script>
   
    
  
    <script>
      // Load sales data when the sales section is shown
      let monthlySalesChartInstance = null;
      let ordersStatusChartInstance = null;
      let categorySalesChartInstance = null;
      document.addEventListener('DOMContentLoaded', () => {
        const salesTab = document.querySelector('[onclick="showSection(\'sales\')"]');
        if (salesTab) {
          salesTab.addEventListener('click', loadSalesData);
        }
      });

      // Fetch and display sales data
      async function loadSalesData() {
        try {
          console.log('Fetching sales data...'); // Debug log

          const response = await fetch('/api/v1/admin/sales-analytics', {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          });

          console.log('Response status:', response.status); // Debug log

          if (response.status === 401) {
            console.error('Authentication error: Not logged in');
            alert('Please log in to view sales data');
            return;
          }

          if (response.status === 403) {
            console.error('Authorization error: Not an admin');
            alert('Access denied. Admin privileges required.');
            return;
          }

          if (!response.ok) {
            const errorData = await response.json().catch(() => null);
            console.error('Error response:', errorData);
            throw new Error(errorData?.message || `HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log('Sales data received:', data); // Debug log

          if (!data) {
            throw new Error('No data received from server');
          }

          // Update Best Seller
          const bestSellerElement = document.getElementById('salesBestSellerName');
          const bestSellerRevenueElement = document.getElementById('salesBestSellerRevenue');
          const bestSellerCountElement = document.getElementById('salesBestSellerCount');

          if (bestSellerElement && bestSellerRevenueElement && bestSellerCountElement) {
            bestSellerElement.textContent = data.bestSeller.name || 'No sales';
            bestSellerRevenueElement.textContent = `$${(data.bestSeller.revenue || 0).toFixed(2)}`;
            bestSellerCountElement.textContent = `${data.bestSeller.count || 0} sold this month`;
          }

          // Update Top Customer
          const topCustomerElement = document.getElementById('salesTopCustomerName');
          const topCustomerSpendElement = document.getElementById('salesTopCustomerSpend');
          const topCustomerOrdersElement = document.getElementById('salesTopCustomerOrders');

          if (topCustomerElement && topCustomerSpendElement && topCustomerOrdersElement) {
            topCustomerElement.textContent = data.topCustomer.name || 'No customers';
            topCustomerSpendElement.textContent = `$${(data.topCustomer.spend || 0).toFixed(2)}`;
            topCustomerOrdersElement.textContent = `${data.topCustomer.orders || 0} orders this month`;
          }

          // Update Top Category
          const topCategoryElement = document.getElementById('salesTopCategoryName');
          const topCategorySalesElement = document.getElementById('salesTopCategorySales');
          const topCategoryCountElement = document.getElementById('salesTopCategoryCount');

          if (topCategoryElement && topCategorySalesElement && topCategoryCountElement) {
            topCategoryElement.textContent = data.topCategory._id || 'No sales';
            topCategorySalesElement.textContent = `$${(data.topCategory.sales || 0).toFixed(2)}`;
            topCategoryCountElement.textContent = `${data.topCategory.count || 0} sales this month`;
          }

          // Update Monthly Sales Bar Chart
          const canvas = document.getElementById('monthlySalesChart');
          if (canvas) {
             const ctx = canvas.getContext('2d');
             // Destroy previous instance to avoid duplicate canvas errors
             if (monthlySalesChartInstance) {
               monthlySalesChartInstance.destroy();
             }
             monthlySalesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: data.monthlySales.map(sale => sale.month),
                  datasets: [{
                    label: 'Sales (EGP)',
                    data: data.monthlySales.map(sale => sale.total),
                    backgroundColor: 'rgba(78,115,223,0.6)',
                    borderColor: '#4e73df',
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function(value) {
                          return value.toLocaleString() + ' EGP';
                        }
                      }
                    }
                  },
                  plugins: {
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          return context.raw.toLocaleString() + ' EGP';
                        }
                      }
                    }
                  }
                }
              });
          }

          /* Orders Status Doughnut */
          const statusCanvas = document.getElementById('ordersStatusChart');
          if(statusCanvas){
             const ctxStatus = statusCanvas.getContext('2d');
             if(ordersStatusChartInstance){ ordersStatusChartInstance.destroy(); }
             const labelsStatus = Object.keys(data.ordersStatus);
             const valuesStatus = labelsStatus.map(k=>data.ordersStatus[k]);
             ordersStatusChartInstance = new Chart(ctxStatus,{type:'doughnut',data:{labels:labelsStatus,datasets:[{data:valuesStatus,backgroundColor:['#F6C6EA','#C8B6FF','#B8E0D2','#F5E960']}]} ,options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
          }

          /* Category Sales Bar */
          const catCanvas = document.getElementById('categorySalesChart');
          if(catCanvas){
             const ctxCat = catCanvas.getContext('2d');
             if(categorySalesChartInstance){ categorySalesChartInstance.destroy(); }
             const catLabels = data.categorySales.map(c=>c.category);
             const catValues = data.categorySales.map(c=>c.sales);
             categorySalesChartInstance = new Chart(ctxCat,{type:'bar',data:{labels:catLabels,datasets:[{label:'Sales (EGP)',data:catValues,backgroundColor:'#FFB5A7'}]},options:{responsive:true,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
          }
        } catch (error) {
          console.error('Error loading sales data:', error);
          alert(`Failed to load sales data: ${error.message}`);
        }
      }
    </script>
    <script>
      // Role change functionality
      document.querySelectorAll(".user-role-select").forEach(select => {
        select.addEventListener("change", async () => {
          const userId = select.getAttribute("data-id");
          const newRole = select.value;

          try {
            const response = await fetch(`/api/v1/users/${userId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ role: newRole })
            });

            if (response.ok) {
              alert("User role updated successfully");
            } else {
              alert("Failed to update user role");
            }
          } catch (error) {
            console.error("Error updating user role:", error);
            alert("Error updating user role");
          }
        });
      });
    </script>
    <script>
      // Handle profile update
      document.addEventListener('DOMContentLoaded', () => {
        const accountForm = document.getElementById('accountForm');
        if (!accountForm) return;

        accountForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('adminName').value.trim();
          const email = document.getElementById('adminEmail').value.trim();
          const phone = document.getElementById('adminPhone').value.trim();

          try {
            const res = await fetch(`/api/v1/users/<%= user ? user._id : '' %>`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, email, phone })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Failed to update');

            alert('Profile updated successfully');
          } catch (err) {
            alert(err.message);
            console.error(err);
          }
        });
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded',()=>{
        const btn=document.getElementById('updatePassBtn');
        const form=document.getElementById('passwordForm');
        if(!btn||!form)return;
        btn.addEventListener('click',async ()=>{
          const currentPass=document.getElementById('currentPass').value.trim();
          const newPass=document.getElementById('newPass').value.trim();
          const confirmPass=document.getElementById('confirmPass').value.trim();
          if(!currentPass||!newPass||!confirmPass){alert('Fill all fields');return;}
          if(newPass!==confirmPass){alert('Passwords do not match');return;}
          try{
            const res=await fetch(`/api/v1/users/<%= user ? user._id : '' %>/change-password`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({currentPassword:currentPass,newPassword:newPass})});
            const data=await res.json();
            if(!res.ok) throw new Error(data.error||'Failed');
            alert('Password updated successfully');form.reset();
          }catch(err){alert(err.message);console.error(err);} }); });
    </script>
  </body>
</html>


