<!-- main header -->

<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
/>
<link rel="stylesheet" href="/css/cart.css">

<header class="main-header style-one style-five">
  <!-- header-lower -->
  <div class="header-lower">
    <div class="outer-box">
      <div class="logo-box">
        <figure class="logo">
          <a href="/"><img src="/img/icon/logo-5.png" alt="" /></a>
        </figure>
      </div>
      <div class="menu-area">
        <!--Mobile Navigation Toggler-->
        <div class="mobile-nav-toggler">
          <i class="icon-bar"></i>
          <i class="icon-bar"></i>
          <i class="icon-bar"></i>
        </div>
        <nav class="main-menu navbar-expand-md navbar-light">
          <div
            class="collapse navbar-collapse show clearfix"
            id="navbarSupportedContent"
          >
            <ul class="navigation clearfix">
              <li>
                <a href="/" style="color: #000">
                  <img
                    src="/img/icons/bakery-shop.png"
                    alt="Home"
                    style="width: 30px; height: 30px; margin-right: 5px"
                  />
                  Home
                </a>
              </li>
              <li>
                <a href="/shop" style="color: #000">
                  <img
                    src="/img/icons/cake.png"
                    alt="Shop"
                    style="width: 30px; height: 30px; margin-right: 5px"
                  />
                  Shop
                </a>
              </li>
              <li class="dropdown">
                <a href="/categories" style="color: #000">
                  <img
                    src="/img/icons/confectioner.png"
                    alt="Categories"
                    style="width: 30px; height: 30px; margin-right: 5px"
                  />
                  Categories
                </a>
                <ul>
                  <li>
                    <a href="/shop?category=Cake" style="color: #000">
                      <img
                        src="/img/icons/cake.png"
                        alt="Cakes"
                        style="width: 30px; height: 30px; margin-right: 5px"
                      />
                      Cakes
                    </a>
                  </li>
                  <li>
                    <a href="/shop?category=Cookie" style="color: #000">
                      <img
                        src="/img/icons/cookie.png"
                        alt="Cookies"
                        style="width: 30px; height: 30px; margin-right: 5px"
                      />
                      Cookies
                    </a>
                  </li>
                  <li>
                    <a href="/shop?category=Croissant" style="color: #000">
                      <img
                        src="/img/icons/croissantF.png"
                        alt="Croissants"
                        style="width: 30px; height: 30px; margin-right: 5px"
                      />
                      Croissants
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="/custom-order" class="requires-login" style="color: #000">
                  <img
                    src="/img/icons/cupcake.png"
                    alt="Custom Order"
                    style="width: 30px; height: 30px; margin-right: 5px"
                  />
                  Custom Order
                </a>
              </li>
              <li class="dropdown">
                <a href="/about-us" style="color: #000">
                  <img
                    src="/img/icons/sign.png"
                    alt="About Us"
                    style="width: 30px; height: 30px; margin-right: 5px"
                  />
                  About Us
                </a>
                <ul>
                  <li>
                    <a href="/about-us" style="color: #000">
                      <img
                        src="/img/icons/dough.png"
                        alt="Our Story"
                        style="width: 30px; height: 30px; margin-right: 5px"
                      />
                      Our Story
                    </a>
                  </li>
                  <li>
                    <a href="/contact-us" style="color: #000">
                      <img
                        src="/img/icons/phone-call.png"
                        alt="Contact Us"
                        style="width: 30px; height: 30px; margin-right: 5px"
                      />
                      Contact Us
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <ul class="menu-right-content clearfix">
        <li class="search-box-outer">
          <button
            class="search-box-btn"
            type="button"
            id="searchToggle"
            style="color: #000; background: none; border: none; padding: 8px 12px; display: flex; align-items: center;"
          >
            <img
              src="/img/icons/whisk (1).png"
              alt="Search"
              style="width: 30px; height: 30px"
            />
          </button>
          <div class="search-panel" id="searchPanel" style="display: none;">
            <form method="post" action="/search" class="p-3">
              <div class="form-group position-relative">
                <input
                  type="search"
                  name="search-field"
                  class="form-control"
                  placeholder="Search...."
                  required
                />
                <button type="submit" class="search-btn">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
          </div>
        </li>
        <li class="user-btn">
          <% if (user == null){%>
          <button
            type="button"
            class="btn btn-link p-0"
            data-bs-toggle="modal"
            data-bs-target="#authModal"
            style="text-decoration: none; color: #000; border: 1px solid #000; border-radius: 20px; padding: 5px 15px !important; transition: all 0.3s ease;"
          >
            join us
          </button>
          <% }else{%>
          <div class="dropdown">
            <button
              class="btn btn-link p-0"
              type="button"
              id="accountDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              style="background: none; border: none; padding: 8px 12px; display: flex; align-items: center;"
            >
              <img
                src="/img/icons/baker.png"
                alt="User"
                style="width: 30px; height: 30px"
              />
            </button>
            <ul class="dropdown-menu" aria-labelledby="accountDropdown" style="min-width: 200px; padding: 5px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); position: absolute; right: 0; top: calc(100% + 20px); z-index: 1000; background: white;">
              <li style="display: block; width: 100%;">
                <a class="dropdown-item" href="/account" style="color: #000; padding: 8px 15px; display: block; width: 100%; text-decoration: none;">
                  <img src="/img/icons/baker.png" alt="My Account" style="width: 20px; height: 20px; margin-right: 5px;"/>
                  My Account
                </a>
              </li>
              <li style="display: block; width: 100%;"><hr class="dropdown-divider" style="margin: 8px 0;"></li>
              <li style="display: block; width: 100%;">
                <a class="dropdown-item" href="/api/v1/users/logout" style="color: #000; padding: 8px 15px; display: block; width: 100%; text-decoration: none;">
                  <img src="/img/icons/exit.png" alt="Logout" style="width: 20px; height: 20px; margin-right: 5px;"/>
                  Logout
                </a>
              </li>
            </ul>
          </div>
          <% }%>
        </li>
        <% if (user != null){%>
        <li class="cart-btn">
          <button class="btn position-relative" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" style="background: none; border: none; padding: 8px 12px;">
            <img src="/img/icons/shopping-cart.png" alt="Cart" style="width: 30px; height: 30px;" />
            <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7rem; padding: 0.25em 0.5em;">
              0
            </span>
          </button>
        </li>
        <% }%>
      </ul>
    </div>
  </div>

  <!--sticky Header-->
  <div class="sticky-header">
    <div class="outer-box">
      <div class="logo-box">
        <figure class="logo">
          <a href="/"><img src="/img/icon/logo-5.png" alt="" /></a>
        </figure>
      </div>
      <div class="menu-area">
        <nav class="main-menu clearfix">
          <!--Keep This Empty / Menu will come through Javascript-->
        </nav>
      </div>
      <ul class="menu-right-content clearfix">
        <li class="search-box-outer">
          <button
            class="search-box-btn"
            type="button"
            id="searchToggle"
            style="color: #000; background: none; border: none; padding: 8px 12px; display: flex; align-items: center;"
          >
            <img
              src="/img/icons/whisk (1).png"
              alt="Search"
              style="width: 30px; height: 30px"
            />
          </button>
          <div class="search-panel" id="searchPanel" style="display: none;">
            <form method="post" action="/search" class="p-3">
              <div class="form-group position-relative">
                <input
                  type="search"
                  name="search-field"
                  class="form-control"
                  placeholder="Search...."
                  required
                />
                <button type="submit" class="search-btn">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
          </div>
        </li>
        <li class="user-btn">
          <% if (user == null){%>
          <button
            type="button"
            class="btn btn-link p-0"
            data-bs-toggle="modal"
            data-bs-target="#authModal"
            style="text-decoration: none; color: #000; border: 1px solid #000; border-radius: 20px; padding: 5px 15px !important; transition: all 0.3s ease;"
          >
            join us
          </button>
          <% }else{%>
          <div class="dropdown">
            <button
              class="btn btn-link p-0"
              type="button"
              id="accountDropdown"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              style="background: none; border: none; padding: 8px 12px; display: flex; align-items: center;"
            >
              <img
                src="/img/icons/baker.png"
                alt="User"
                style="width: 30px; height: 30px"
              />
            </button>
            <ul class="dropdown-menu" aria-labelledby="accountDropdown" style="min-width: 200px; padding: 5px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); position: absolute; right: 0; top: calc(100% + 20px); z-index: 1000; background: white;">
              <li style="display: block; width: 100%;">
                <a class="dropdown-item" href="/account" style="color: #000; padding: 8px 15px; display: block; width: 100%; text-decoration: none;">
                  <img src="/img/icons/baker.png" alt="My Account" style="width: 20px; height: 20px; margin-right: 5px;"/>
                  My Account
                </a>
              </li>
              <li style="display: block; width: 100%;"><hr class="dropdown-divider" style="margin: 8px 0;"></li>
              <li style="display: block; width: 100%;">
                <a class="dropdown-item" href="/api/v1/users/logout" style="color: #000; padding: 8px 15px; display: block; width: 100%; text-decoration: none;">
                  <img src="/img/icons/sign.png" alt="Logout" style="width: 20px; height: 20px; margin-right: 5px;"/>
                  Logout
                </a>
              </li>
            </ul>
          </div>
          <% }%>
        </li>
        <% if (user != null){%>
        <li class="cart-btn">
          <button class="btn position-relative" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" style="background: none; border: none; padding: 8px 12px;">
            <img src="/img/icons/shopping-cart.png" alt="Cart" style="width: 30px; height: 30px;" />
            <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7rem; padding: 0.25em 0.5em;">
              0
            </span>
          </button>
        </li>
        <% }%>
      </ul>
    </div>
  </div>
</header>
<style>
  .menu-right-content .search-box-btn img,
  .menu-right-content .user-btn img,
  .menu-right-content .cart-btn img {
    transition: transform 0.3s ease;
  }

  .menu-right-content .search-box-btn img:hover,
  .menu-right-content .user-btn img:hover,
  .menu-right-content .cart-btn img:hover {
    transform: scale(1.3);
  }
</style>
<!-- main-header end -->

<!-- Mobile Menu  -->
<div class="mobile-menu">
  <div class="menu-backdrop"></div>
  <div class="close-btn"><i class="fas fa-times"></i></div>

  <nav class="menu-box">
    <div class="nav-logo">
      <a href="/"><img src="/img/icon/logo-5.png" alt="" title="" /></a>
    </div>
    <div class="menu-outer">
      <!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header-->
    </div>
  </nav>
</div>
<!-- End Mobile Menu -->

<!-- Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-black" id="modalTitle">Sign Up</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body">
        <!-- Sign Up Form -->
        <form id="signupForm">
          <div class="mb-3">
            <label for="signupName" class="form-label">Name</label>
            <input type="text" class="form-control" id="signupName" />
          </div>
          <div class="mb-3">
            <label for="signupEmail" class="form-label">Email address</label>
            <input type="text" class="form-control" id="signupEmail" />
          </div>
          <div class="mb-3 position-relative">
            <label for="signupPassword" class="form-label">Password</label>
            <input
              type="password"
              class="form-control pe-5"
              id="signupPassword"
            />
            <i
              class="bi bi-eye-slash toggle-password position-absolute top-50 translate-middle-y"
              data-target="signupPassword"
              style="cursor: pointer; right: 1rem"
            ></i>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="toggleBtn"
              class="btn btn-outline-secondary"
            >
              Switch to Sign In
            </button>
            <button type="submit" class="btn btn-primary">Sign Up</button>
          </div>
        </form>

        <!-- Sign In Form -->
        <form id="signinForm" class="d-none">
          <div class="mb-3">
            <label for="signinEmail" class="form-label">Email address</label>
            <input type="text" class="form-control" id="signinEmail" />
          </div>
          <div class="mb-3 position-relative">
            <label for="signinPassword" class="form-label">Password</label>
            <input
              type="password"
              class="form-control pe-5"
              id="signinPassword"
            />
            <i
              class="bi bi-eye-slash toggle-password position-absolute top-50 translate-middle-y"
              data-target="signinPassword"
              style="cursor: pointer; right: 1rem"
            ></i>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="toggleBtnSignin"
              class="btn btn-outline-secondary"
            >
              Switch to Sign Up
            </button>
            <button type="submit" class="btn btn-primary">Sign In</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script
  type="text/javascript"
  src="https://cdn.jsdelivr.net/npm/toastify-js"
></script>
<script src="/js/cart.js"></script>

<!-- Include Cart Partial -->
<%- include('cart') %>

<!-- JavaScript -->
<script>
  function showToast(text, type = "success") {
    const colors = {
      success: "#28a745",
      error: "#dc3545",
    };

    Toastify({
      text,
      duration: 3000,
      newWindow: false,
      close: true,
      gravity: "top",
      position: "right",
      stopOnFocus: true,
      style: {
        background: colors[type] || colors.success,
      },
    }).showToast();
  }

  const modalTitle = document.getElementById("modalTitle");
  const signupForm = document.getElementById("signupForm");
  const signinForm = document.getElementById("signinForm");

  const toggleBtn = document.getElementById("toggleBtn");
  const toggleBtnSignin = document.getElementById("toggleBtnSignin");

  // Toggle to Sign In
  toggleBtn.addEventListener("click", () => {
    signupForm.classList.add("d-none");
    signinForm.classList.remove("d-none");
    modalTitle.textContent = "Sign In";
  });

  // Toggle to Sign Up
  toggleBtnSignin.addEventListener("click", () => {
    signinForm.classList.add("d-none");
    signupForm.classList.remove("d-none");
    modalTitle.textContent = "Sign Up";
  });

  // Password toggle
  document.querySelectorAll(".toggle-password").forEach((icon) => {
    icon.style.position = "absolute";
    icon.addEventListener("click", () => {
      const target = document.getElementById(icon.dataset.target);
      if (target.type === "password") {
        target.type = "text";
        icon.classList.remove("bi-eye-slash");
        icon.classList.add("bi-eye");
      } else {
        target.type = "password";
        icon.classList.remove("bi-eye");
        icon.classList.add("bi-eye-slash");
      }
    });
  });

  ///////////////////////////////////////////////////////////////////////////////////////////////////////

  // Handle Sign Up
  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("signupName").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPassword").value.trim();

    if (!name || !email || !password) {
      showToast("All fields are required", "error");
      return;
    }

    if (name.length < 2) {
      showToast("Name must be at least 2 characters", "error");
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showToast("Please enter a valid email address", "error");
      return;
    }

    if (password.length < 6) {
      showToast("Password must be at least 6 characters", "error");
      return;
    }

    try {
      const response = await fetch("/api/v1/users/sign-up", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, email, password }),
      });

      const data = await response.json();

      if (!response.ok) {
        showToast(data.error || "Signup failed", "error");
        return;
      }

      showToast("User registered successfully!", "success");
      document.getElementById("signupForm").reset();
    } catch (error) {
      console.error("Signup error:", error);
      showToast("Something went wrong. Try again later.", "error");
    }
  });

  // Handle Sign In
  signinForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("signinEmail").value;
    const password = document.getElementById("signinPassword").value;

    if (!email || !password) {
      showToast("All fields are required", "error");
      return;
    }

    try {
      const response = await fetch("/api/v1/users/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (!response.ok) {
        showToast(data.error || "Login failed", "error");
        return;
      }

      showToast("User Logged successfully!", "success");
      setTimeout(() => {
        window.location = `/${data.user.role}`;
      }, 1000);
    } catch (error) {
      console.error("Signin error:", error);
      showToast("Something went wrong. Try again later.", "error");
    }
  });

  // Initialize Bootstrap dropdowns
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap dropdowns
    const dropdowns = document.querySelectorAll('[data-bs-toggle="dropdown"]');
    dropdowns.forEach(dropdown => {
      new bootstrap.Dropdown(dropdown);
    });

    // Handle search form submission
    const searchForms = document.querySelectorAll('.search-panel form');
    searchForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const searchInput = this.querySelector('input[type="search"]');
        if (!searchInput.value.trim()) {
          e.preventDefault();
        }
      });
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
    const searchToggle = document.getElementById('searchToggle');
    const searchPanel = document.getElementById('searchPanel');
    
    // Toggle search panel
    searchToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';
    });

    // Close search panel when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchPanel.contains(e.target) && !searchToggle.contains(e.target)) {
        searchPanel.style.display = 'none';
      }
    });

    // Handle search form submission
    const searchForms = document.querySelectorAll('.search-panel form');
    searchForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const searchInput = this.querySelector('input[type="search"]');
        if (!searchInput.value.trim()) {
          e.preventDefault();
        }
      });
    });
  });

  window.currentUserId = '<%= typeof user !== "undefined" && user ? user._id : "" %>';

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('a.requires-login').forEach(link => {
      link.addEventListener('click', function(e) {
        if (!window.currentUserId) {
          e.preventDefault();
          showToast('Please login first to access this page', 'error');
        }
      });
    });
  });
</script>
